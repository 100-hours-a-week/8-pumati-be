pipeline {
    // íŒŒì´í”„ë¼ì¸ ì „ì²´ë¥¼ Docker ì»¨í…Œì´ë„ˆì—ì„œ ì‹¤í–‰
    agent {
        kubernetes {
            yaml '''
apiVersion: v1
kind: Pod
spec:
  securityContext:
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
  containers:
  - name: openjdk
    image: cimg/openjdk:21.0
    command: [cat]
    tty: true
    securityContext:
      runAsUser: 1000
      runAsGroup: 1000
    volumeMounts:
    - name: workspace-volume
      mountPath: /home/jenkins/agent
  - name: kaniko
    image: gcr.io/kaniko-project/executor:debug
    command: [/busybox/cat]
    tty: true
    volumeMounts:
    - name: workspace-volume
      mountPath: /home/jenkins/agent
  - name: aws-cli
    image: cimg/aws:2023.05
    command: [cat]
    tty: true
    securityContext:
      runAsUser: 1000
      runAsGroup: 1000
    volumeMounts:
    - name: workspace-volume
      mountPath: /home/jenkins/agent
  volumes:
  - name: workspace-volume
    emptyDir: {}
            '''
        }
    }
    
    // í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
    environment {
        // AWS ê³µê°œ ì •ë³´ (ê¹ƒì— ì˜¬ë ¤ë„ ì•ˆì „)
        AWS_REGION = 'ap-northeast-2'        // ì„œìš¸ ë¦¬ì „
        ECR_REPOSITORY = 'pumati-dev-backend-ecr'  // ECR ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„
        
        // ì´ë¯¸ì§€ íƒœê·¸ ì„¤ì • (ë¸Œëœì¹˜ëª…ê³¼ ë¹Œë“œ ë²ˆí˜¸ ì¡°í•©)
        IMAGE_TAG = "${BRANCH_NAME}-${BUILD_NUMBER}"
        
        // Gradle í™ˆ ë””ë ‰í† ë¦¬ ì„¤ì • (ê¶Œí•œ ë¬¸ì œ í•´ê²°)
        GRADLE_USER_HOME = '/home/jenkins/agent/.gradle'
        GRADLE_OPTS = '-Dorg.gradle.daemon=false -Dorg.gradle.caching=false'
        
        // Java ë²„ì „ ì„¤ì • (ì‹œìŠ¤í…œ ê¸°ë³¸ Java ì‚¬ìš©)
        // Jenkins ì„œë²„ì— Java 21ì´ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•¨
        // JAVA_HOME = tool name: 'jdk-21', type: 'jdk'
        // PATH = "${JAVA_HOME}/bin:${PATH}"
    }
    
    stages {
        // 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        stage('Checkout') {
            steps {
                container('openjdk') {
                    echo 'ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ ì™„ë£Œ'
                    script {
                        // ë” ê°„ë‹¨í•˜ê³  ì•ˆì „í•œ Git ëª…ë ¹ì–´ ì‚¬ìš©
                        try {
                            def gitCommit = sh(
                                script: 'git rev-parse HEAD',
                                returnStdout: true
                            ).trim()
                            echo "Git Commit: ${gitCommit}"
                        } catch (Exception e) {
                            echo "Git commit ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${e.getMessage()}"
                        }
                        
                        try {
                            def gitBranch = sh(
                                script: 'git branch --show-current || echo "detached"',
                                returnStdout: true
                            ).trim()
                            echo "Git Branch: ${gitBranch}"
                        } catch (Exception e) {
                            echo "Git branch ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${e.getMessage()}"
                        }
                        
                        // ì‘ì—… ë””ë ‰í† ë¦¬ í™•ì¸
                        sh 'pwd'
                        sh 'ls -la'
                    }
                }
            }
        }
        
        // 2. í™˜ê²½ ì„¤ì • íŒŒì¼ ì¤€ë¹„
        stage('Setup Environment') {
            steps {
                container('openjdk') {
                    echo 'í™˜ê²½ ì„¤ì • íŒŒì¼ ë° AWS ì •ë³´ ì¤€ë¹„ ì¤‘...'
                    
                    script {
                        withCredentials([string(credentialsId: 'aws-account-id', variable: 'AWS_ACCOUNT_ID')]) {
                            env.DOCKER_IMAGE_NAME = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}:${IMAGE_TAG}"
                            env.LATEST_IMAGE_NAME = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}:latest"
                            echo "Docker ì´ë¯¸ì§€: ${env.DOCKER_IMAGE_NAME}"
                            echo "Latest ì´ë¯¸ì§€: ${env.LATEST_IMAGE_NAME}"
                        }
                    }
                    
                    withCredentials([file(credentialsId: 'be-env', variable: 'ENV_FILE')]) {
                        sh 'cp $ENV_FILE .env'
                        sh 'ls -la .env'
                    }
                }
            }
        }
        
        // 3. Gradle ë¹Œë“œ ì¤€ë¹„
        stage('Prepare Build') {
            steps {
                container('openjdk') {
                    echo 'Gradle ë¹Œë“œ ì¤€ë¹„ ì¤‘...'
                    script {
                        // Gradle í™ˆ ë””ë ‰í† ë¦¬ ìƒì„±
                        sh 'mkdir -p /home/jenkins/agent/.gradle'
                        sh 'id && pwd && ls -la /home/jenkins/agent/'
                        
                        try {
                            sh 'java -version'
                        } catch (Exception e) {
                            echo "Java ë²„ì „ í™•ì¸ ì‹¤íŒ¨: ${e.getMessage()}"
                        }
                        
                        try {
                            sh 'chmod +x gradlew'
                            echo 'gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ ì™„ë£Œ'
                        } catch (Exception e) {
                            echo "gradlew ê¶Œí•œ ì„¤ì • ì‹¤íŒ¨: ${e.getMessage()}"
                        }
                        
                        try {
                            sh 'GRADLE_USER_HOME=/home/jenkins/agent/.gradle ./gradlew --version'
                        } catch (Exception e) {
                            echo "Gradle ë²„ì „ í™•ì¸ ì‹¤íŒ¨: ${e.getMessage()}"
                        }
                    }
                }
            }
        }
        
        // 4. í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        stage('Test') {
            steps {
                container('openjdk') {
                    echo 'ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...'
                    script {
                        try {
                            // í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰
                            sh '''
                                # Gradle í™ˆ ë””ë ‰í† ë¦¬ í™•ì¸
                                export GRADLE_USER_HOME=/home/jenkins/agent/.gradle
                                mkdir -p $GRADLE_USER_HOME
                                
                                if [ -f .env ]; then
                                    echo "í™˜ê²½ íŒŒì¼ ë°œê²¬, ë¡œë“œ ì¤‘..."
                                    set -a && . ./.env && set +a
                                else
                                    echo "í™˜ê²½ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
                                fi
                                
                                echo "í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œì‘..."
                                echo "GRADLE_USER_HOME: $GRADLE_USER_HOME"
                                ./gradlew test --no-daemon --stacktrace --gradle-user-home=$GRADLE_USER_HOME
                            '''
                        } catch (Exception e) {
                            echo "í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜: ${e.getMessage()}"
                            currentBuild.result = 'UNSTABLE'
                        }
                    }
                }
            }
            
            // í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë°œí–‰
            post {
                always {
                    container('openjdk') {
                        script {
                            try {
                                junit testResults: 'build/test-results/test/*.xml', allowEmptyResults: true
                                echo 'í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë°œí–‰ ì™„ë£Œ'
                            } catch (Exception e) {
                                echo "í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë°œí–‰ ì‹¤íŒ¨: ${e.getMessage()}"
                            }
                        }
                    }
                }
            }
        }
        
        // 5. ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
        stage('Build Application') {
            steps {
                container('openjdk') {
                    echo 'Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ì¤‘...'
                    script {
                        try {
                            sh '''
                                export GRADLE_USER_HOME=/home/jenkins/agent/.gradle
                                ./gradlew clean build -x test --no-daemon --stacktrace --gradle-user-home=$GRADLE_USER_HOME
                            '''
                            sh 'ls -la build/libs/'
                            echo 'ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ì™„ë£Œ'
                        } catch (Exception e) {
                            echo "ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ì‹¤íŒ¨: ${e.getMessage()}"
                            error("ë¹Œë“œ ì‹¤íŒ¨")
                        } finally {
                            // ë¹Œë“œ ì™„ë£Œ í›„ í™˜ê²½ íŒŒì¼ ì •ë¦¬
                            sh 'rm -f .env || true'
                            echo '.env íŒŒì¼ ì •ë¦¬ ì™„ë£Œ'
                        }
                    }
                }
            }
        }
        
        // 6. ECR ë¡œê·¸ì¸ ë° ì„¤ì •
        stage('Setup ECR') {
            steps {
                container('aws-cli') {
                    echo 'ECR ë¡œê·¸ì¸ ë° ë¦¬í¬ì§€í† ë¦¬ ì„¤ì • ì¤‘...'
                    withCredentials([
                        string(credentialsId: 'aws-account-id', variable: 'AWS_ACCOUNT_ID'),
                        aws(credentialsId: 'aws-credentials', accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')
                    ]) {
                        sh 'aws --version'
                        sh 'aws sts get-caller-identity'
                        
                        // ECR ë¦¬í¬ì§€í† ë¦¬ ì¡´ì¬ í™•ì¸ ë° ìƒì„±
                        sh """
                            aws ecr describe-repositories --repository-names ${ECR_REPOSITORY} --region ${AWS_REGION} || \\
                            aws ecr create-repository --repository-name ${ECR_REPOSITORY} --region ${AWS_REGION}
                        """
                        
                        // Kanikoìš© ECR ì¸ì¦ ì„¤ì • íŒŒì¼ ìƒì„±
                        sh """
                            mkdir -p /home/jenkins/agent/.docker
                            aws ecr get-login-password --region ${AWS_REGION} | \\
                            echo "{\\"auths\\": {\\"${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com\\": {\\"auth\\": \\"\$(cat - | base64 -w0)\\"}}}" > /home/jenkins/agent/.docker/config.json
                        """
                    }
                }
            }
        }
        
        // 7. Kanikoë¡œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        stage('Build and Push Docker Image') {
            steps {
                container('kaniko') {
                    echo 'Kanikoë¡œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR í‘¸ì‹œ ì¤‘...'
                    
                    // ğŸ”¥ AWS í¬ë ˆë´ì…œì„ Kanikoì—ë„ ì „ë‹¬
                    withCredentials([
                        string(credentialsId: 'aws-account-id', variable: 'AWS_ACCOUNT_ID'),
                        aws(credentialsId: 'aws-credentials', accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')
                    ]) {
                        script {
                            sh """
                                # AWS í™˜ê²½ë³€ìˆ˜ ì„¤ì •
                                export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
                                export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
                                export AWS_DEFAULT_REGION=${AWS_REGION}
                                
                                # Docker config.json íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
                                if [ -f /home/jenkins/agent/.docker/config.json ]; then
                                    echo "âœ… Docker config.json íŒŒì¼ ë°œê²¬"
                                    mkdir -p /kaniko/.docker
                                    cp /home/jenkins/agent/.docker/config.json /kaniko/.docker/config.json
                                else
                                    echo "âŒ Docker config.json íŒŒì¼ ì—†ìŒ"
                                fi
                                
                                # Kaniko executorë¡œ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
                                /kaniko/executor \\
                                    --context=. \\
                                    --dockerfile=ci/dev/Dockerfile \\
                                    --destination=${env.DOCKER_IMAGE_NAME} \\
                                    --destination=${env.LATEST_IMAGE_NAME} \\
                                    --cache=true \\
                                    --compressed-caching=false \\
                                    --cleanup
                            """
                            
                            echo "âœ… ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ ì™„ë£Œ!"
                            echo "ğŸ“¦ ì´ë¯¸ì§€: ${env.DOCKER_IMAGE_NAME}"
                            echo "ğŸ“¦ Latest: ${env.LATEST_IMAGE_NAME}"
                        }
                    }
                }
            }
        }
        
        // 8. ë¹Œë“œ ì •ë¦¬
        stage('Cleanup') {
            steps {
                container('openjdk') {
                    echo 'ë¹Œë“œ ì •ë¦¬ ì¤‘...'
                    sh '''
                        # ì„ì‹œ íŒŒì¼ë“¤ ì •ë¦¬
                        rm -f .env || true
                        rm -rf /home/jenkins/agent/.docker || true
                        echo "ì •ë¦¬ ì™„ë£Œ"
                    '''
                }
            }
        }
    }
    
    // ë¹Œë“œ í›„ ì²˜ë¦¬
    post {
        always {
            script {
                echo 'ë¹Œë“œ íŒŒì´í”„ë¼ì¸ ì™„ë£Œ. ì‘ì—… ê³µê°„ì„ ì •ë¦¬í•©ë‹ˆë‹¤.'
                
                // Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì •ë¦¬
                try {
                    deleteDir()
                    echo 'ì‘ì—… ê³µê°„ ì •ë¦¬ ì™„ë£Œ'
                } catch (Exception e) {
                    echo "ì‘ì—… ê³µê°„ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œë¨): ${e.getMessage()}"
                }
            }
        }
        
        success {
            script {
                echo 'âœ… ë¹Œë“œ ì„±ê³µ! ğŸ‰'
                echo "ğŸ“¦ Docker ì´ë¯¸ì§€: ${env.DOCKER_IMAGE_NAME}"
                echo "ğŸ·ï¸  ì´ë¯¸ì§€ íƒœê·¸: ${env.IMAGE_TAG}"
                echo "ğŸ“ ECR ë¦¬í¬ì§€í† ë¦¬: ${ECR_REPOSITORY}"
                echo "ğŸŒ AWS ë¦¬ì „: ${AWS_REGION}"
            }
        }
        
        failure {
            script {
                echo 'âŒ ë¹Œë“œ ì‹¤íŒ¨!'
                echo "ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ì‹¤íŒ¨ ì›ì¸ì„ íŒŒì•…í•˜ì„¸ìš”."
                echo "ğŸŒ ë¹Œë“œ URL: ${env.BUILD_URL}"
            }
        }
        
        unstable {
            script {
                echo 'âš ï¸ ë¹Œë“œ ë¶ˆì•ˆì •'
                echo "ğŸ“Š í…ŒìŠ¤íŠ¸ì—ì„œ ì¼ë¶€ ì‹¤íŒ¨ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
            }
        }
    }
}
