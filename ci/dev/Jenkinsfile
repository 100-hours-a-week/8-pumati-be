pipeline {
    agent any
    
    // í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
    environment {
        // AWS ê³µê°œ ì •ë³´ (ê¹ƒì— ì˜¬ë ¤ë„ ì•ˆì „)
        AWS_REGION = 'ap-northeast-2'        // ì„œìš¸ ë¦¬ì „
        ECR_REPOSITORY = 'pumati-dev-backend-ecr'  // ECR ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„
        
        // ì´ë¯¸ì§€ íƒœê·¸ ì„¤ì • (ë¸Œëœì¹˜ëª…ê³¼ ë¹Œë“œ ë²ˆí˜¸ ì¡°í•©)
        IMAGE_TAG = "${BRANCH_NAME}-${BUILD_NUMBER}"
        
        // Java ë²„ì „ ì„¤ì • (ì‹œìŠ¤í…œ ê¸°ë³¸ Java ì‚¬ìš©)
        // Jenkins ì„œë²„ì— Java 21ì´ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•¨
        // JAVA_HOME = tool name: 'jdk-21', type: 'jdk'
        // PATH = "${JAVA_HOME}/bin:${PATH}"
    }
    
    stages {
        // 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        stage('Checkout') {
            steps {
                // ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ (ì´ë¯¸ Jenkinsì—ì„œ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë¨)
                echo 'ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ ì™„ë£Œ'
                
                // í˜„ì¬ ë¸Œëœì¹˜ì™€ ì»¤ë°‹ ì •ë³´ ì¶œë ¥
                script {
                    def gitCommit = sh(returnStdout: true, script: 'git rev-parse HEAD').trim()
                    def gitBranch = sh(returnStdout: true, script: 'git rev-parse --abbrev-ref HEAD').trim()
                    echo "Git Branch: ${gitBranch}"
                    echo "Git Commit: ${gitCommit}"
                }
            }
        }
        
        // 2. í™˜ê²½ ì„¤ì • íŒŒì¼ ì¤€ë¹„
        stage('Setup Environment') {
            steps {
                echo 'í™˜ê²½ ì„¤ì • íŒŒì¼ ë° AWS ì •ë³´ ì¤€ë¹„ ì¤‘...'
                
                script {
                    // Jenkins í¬ë ˆë´ì…œì—ì„œ AWS ê³„ì • ID ê°€ì ¸ì˜¤ê¸°
                    withCredentials([string(credentialsId: 'aws-account-id', variable: 'AWS_ACCOUNT_ID')]) {
                        // Docker ì´ë¯¸ì§€ ì´ë¦„ ì„¤ì • (AWS ê³„ì • ID í¬í•¨)
                        env.DOCKER_IMAGE_NAME = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}:${IMAGE_TAG}"
                        echo "Docker ì´ë¯¸ì§€: ${env.DOCKER_IMAGE_NAME}"
                    }
                }
                
                // Jenkins í¬ë ˆë´ì…œì—ì„œ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
                withCredentials([file(credentialsId: 'be-env', variable: 'ENV_FILE')]) {
                    // í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ì„ ì‘ì—… ë””ë ‰í† ë¦¬ì— ë³µì‚¬
                    sh 'cp $ENV_FILE .env'
                    
                    // í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ì´ ì œëŒ€ë¡œ ë³µì‚¬ë˜ì—ˆëŠ”ì§€ í™•ì¸ (ë³´ì•ˆìƒ ë‚´ìš©ì€ ì¶œë ¥í•˜ì§€ ì•ŠìŒ)
                    sh 'ls -la .env'
                }
            }
        }
        
        // 3. Gradle ë¹Œë“œ ì¤€ë¹„
        stage('Prepare Build') {
            steps {
                echo 'Gradle ë¹Œë“œ ì¤€ë¹„ ì¤‘...'
                
                // Java ë²„ì „ í™•ì¸
                sh '''
                    echo "í˜„ì¬ Java ë²„ì „ í™•ì¸:"
                    java -version
                    echo "JAVA_HOME: $JAVA_HOME"
                '''
                
                // Gradle wrapper ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
                sh 'chmod +x gradlew'
                
                // Gradle ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ ë° ë²„ì „ í™•ì¸
                sh './gradlew --version'
            }
        }
        
        // 4. í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        stage('Test') {
            steps {
                echo 'ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...'
                
                // ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
                // sh './gradlew test'
            }
            
            // í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë°œí–‰
            post {
                always {
                    // í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì¼ ë°œí–‰
                    publishTestResults testResultsPattern: 'build/test-results/test/*.xml'
                    
                    // í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ë°œí–‰ (JaCoCo ë“±ì„ ì‚¬ìš©í•  ê²½ìš°)
                    // publishHTML([
                    //     allowMissing: false,
                    //     alwaysLinkToLastBuild: true,
                    //     keepAll: true,
                    //     reportDir: 'build/reports/jacoco/test/html',
                    //     reportFiles: 'index.html',
                    //     reportName: 'JaCoCo Coverage Report'
                    // ])
                }
            }
        }
        
        // 5. ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
        stage('Build Application') {
            steps {
                echo 'Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ì¤‘...'
                
                // Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ (jar íŒŒì¼ ìƒì„±)
                sh './gradlew clean build -x test'
                
                // ë¹Œë“œ ê²°ê³¼ í™•ì¸
                sh 'ls -la build/libs/'
            }
        }
        
        // 6. Docker ì´ë¯¸ì§€ ë¹Œë“œ
        stage('Build Docker Image') {
            steps {
                echo 'Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘...'
                
                script {
                    // Docker ì´ë¯¸ì§€ ë¹Œë“œ
                    sh """
                        docker build -f ci/dev/Dockerfile \
                            -t ${env.DOCKER_IMAGE_NAME} \
                            -t ${ECR_REPOSITORY}:latest \
                            .
                    """
                    
                    // ë¹Œë“œëœ ì´ë¯¸ì§€ í™•ì¸
                    sh "docker images ${ECR_REPOSITORY}"
                }
            }
        }
        
        // 7. ECR ë¡œê·¸ì¸ ë° ì´ë¯¸ì§€ í‘¸ì‹œ
        stage('Push to ECR') {
            steps {
                echo 'ECRì— Docker ì´ë¯¸ì§€ í‘¸ì‹œ ì¤‘...'
                
                script {
                    // AWS í¬ë ˆë´ì…œê³¼ ê³„ì • IDë¥¼ ëª¨ë‘ ì‚¬ìš© (ë³´ì•ˆ ê°•í™”)
                    withCredentials([
                        string(credentialsId: 'aws-account-id', variable: 'AWS_ACCOUNT_ID'),
                        aws(credentialsId: 'aws-credentials', accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')
                    ]) {
                        // AWS í™˜ê²½ ë³€ìˆ˜ ì„¤ì • í™•ì¸
                        sh """
                            echo "AWS ì¸ì¦ ì •ë³´ í™•ì¸ ì¤‘..."
                            aws sts get-caller-identity
                        """
                        
                        // AWS ECRì— ë¡œê·¸ì¸
                        sh """
                            echo "ECRì— ë¡œê·¸ì¸ ì¤‘..."
                            aws ecr get-login-password --region ${AWS_REGION} | \
                            docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com
                        """
                        
                        // ECR ë¦¬í¬ì§€í† ë¦¬ ì¡´ì¬ í™•ì¸ ë° ìƒì„±
                        sh """
                            echo "ECR ë¦¬í¬ì§€í† ë¦¬ í™•ì¸ ë° ìƒì„± ì¤‘..."
                            aws ecr describe-repositories --repository-names ${ECR_REPOSITORY} --region ${AWS_REGION} || \
                            aws ecr create-repository --repository-name ${ECR_REPOSITORY} --region ${AWS_REGION}
                        """
                        
                        // Docker ì´ë¯¸ì§€ë¥¼ ECRì— í‘¸ì‹œ
                        sh """
                            echo "Docker ì´ë¯¸ì§€ í‘¸ì‹œ ì¤‘: ${env.DOCKER_IMAGE_NAME}"
                            docker push ${env.DOCKER_IMAGE_NAME}
                        """
                        
                        // latest íƒœê·¸ë„ í‘¸ì‹œ
                        def latestImageName = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}:latest"
                        sh """
                            echo "Latest íƒœê·¸ í‘¸ì‹œ ì¤‘: ${latestImageName}"
                            docker tag ${env.DOCKER_IMAGE_NAME} ${latestImageName}
                            docker push ${latestImageName}
                        """
                    }
                }
            }
        }
        
        // 8. ë¹Œë“œ ì •ë¦¬
        stage('Cleanup') {
            steps {
                echo 'ë¹Œë“œ ì •ë¦¬ ì¤‘...'
                
                script {
                    // ë¡œì»¬ Docker ì´ë¯¸ì§€ ì •ë¦¬ (ë””ìŠ¤í¬ ê³µê°„ ì ˆì•½)
                    sh """
                        docker rmi ${env.DOCKER_IMAGE_NAME} || true
                        docker rmi ${ECR_REPOSITORY}:latest || true
                        docker system prune -f
                    """
                }
            }
        }
    }
    
    // ë¹Œë“œ í›„ ì²˜ë¦¬
    post {
        always {
            echo 'ë¹Œë“œ íŒŒì´í”„ë¼ì¸ ì™„ë£Œ'
            
            // í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ì •ë¦¬
            sh 'rm -f .env'
            
            // ì‘ì—… ê³µê°„ ì •ë¦¬
            cleanWs()
        }
        
        success {
            echo 'ë¹Œë“œ ì„±ê³µ! ğŸ‰'
            
            // ì„±ê³µ ì‹œ ì•Œë¦¼ (Slack, ì´ë©”ì¼ ë“±)
            // slackSend(
            //     color: 'good',
            //     message: ":white_check_mark: ë¹Œë“œ ì„±ê³µ: ${env.JOB_NAME} - ${env.BUILD_NUMBER}"
            // )
        }
        
        failure {
            echo 'ë¹Œë“œ ì‹¤íŒ¨! âŒ'
            
            // ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
            // slackSend(
            //     color: 'danger',
            //     message: ":x: ë¹Œë“œ ì‹¤íŒ¨: ${env.JOB_NAME} - ${env.BUILD_NUMBER}"
            // )
        }
        
        unstable {
            echo 'ë¹Œë“œ ë¶ˆì•ˆì • âš ï¸'
        }
    }
}
