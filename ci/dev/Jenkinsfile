pipeline {
    // íŒŒì´í”„ë¼ì¸ ì „ì²´ë¥¼ Docker ì»¨í…Œì´ë„ˆì—ì„œ ì‹¤í–‰
    agent {
        kubernetes {
            yaml '''
apiVersion: v1
kind: Pod
spec:
  # ë…¸ë“œ ì…€ë ‰í„° ì œê±° - ì–´í”¼ë‹ˆí‹°ë¡œë§Œ ë…¸ë“œ ì„ íƒ (ìœ ì—°í•œ ìŠ¤ì¼€ì¤„ë§)
  # nodeSelector:
  #   node-type: "application"
  
  # ë…¸ë“œ ì„ íƒ ìš°ì„ ìˆœìœ„ ì„¤ì •
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      # 1ìˆœìœ„: application íƒ€ì… ë…¸ë“œ (ì¹´íœí„° ë…¸ë“œí’€)
      - weight: 100
        preference:
          matchExpressions:
          - key: node-type
            operator: In
            values: ["application"]
      # 2ìˆœìœ„: system íƒ€ì… ë…¸ë“œ (ê¸°ì¡´ ë…¸ë“œ)
      - weight: 80
        preference:
          matchExpressions:
          - key: node-type
            operator: In
            values: ["system"]
      # 3ìˆœìœ„: t3.medium/t3a.medium ì¸ìŠ¤í„´ìŠ¤
      - weight: 50
        preference:
          matchExpressions:
          - key: kubernetes.io/instance-type
            operator: In
            values: ["t3.medium", "t3a.medium"]
      # 4ìˆœìœ„: ê¸°íƒ€ ì ì ˆí•œ í¬ê¸°ì˜ ì¸ìŠ¤í„´ìŠ¤ (fallback)
      - weight: 30
        preference:
          matchExpressions:
          - key: kubernetes.io/instance-type
            operator: In
            values: ["t3.large", "t3a.large"]
  securityContext:
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
  containers:
  - name: openjdk
    image: cimg/openjdk:21.0
    command: [cat]
    tty: true
    securityContext:
      runAsUser: 1000
      runAsGroup: 1000
    # t3.medium ìŠ¤í™ì— ìµœì í™”ëœ ë¦¬ì†ŒìŠ¤ ì„¤ì • - Java ë¹Œë“œìš©
    resources:
      requests:
        memory: "2Gi"
        cpu: "1000m"
      limits:
        memory: "3Gi"
        cpu: "1500m"
    volumeMounts:
    - name: workspace-volume
      mountPath: /home/jenkins/agent
  - name: kaniko
    image: gcr.io/kaniko-project/executor:debug
    command: [/busybox/cat]
    tty: true
    securityContext:
      runAsUser: 0
      runAsGroup: 0
    # t3.medium ìŠ¤í™ì— ìµœì í™”ëœ ë¦¬ì†ŒìŠ¤ ì„¤ì • - Docker ë¹Œë“œìš©
    resources:
      requests:
        memory: "512Mi"    # 512MB ìš”ì²­ (Docker ë¹Œë“œ ê¸°ë³¸)
        cpu: "300m"        # 0.3 CPU ìš”ì²­
      limits:
        memory: "1.5Gi"    # 1.5GB ì œí•œ (Docker ë¹Œë“œì— ì¶©ë¶„)
        cpu: "800m"        # 0.8 CPU ì œí•œ
    volumeMounts:
    - name: workspace-volume
      mountPath: /home/jenkins/agent
  - name: aws-cli
    image: cimg/aws:2023.05
    command: [cat]
    tty: true
    securityContext:
      runAsUser: 1000
      runAsGroup: 1000
    # t3.medium ìŠ¤í™ì— ìµœì í™”ëœ ë¦¬ì†ŒìŠ¤ ì„¤ì • - AWS CLIìš© (ê°€ë²¼ìš´ ì‘ì—…)
    resources:
      requests:
        memory: "256Mi"    # 256MB ìš”ì²­ (AWS CLI ì‘ì—…ìš©)
        cpu: "200m"        # 0.2 CPU ìš”ì²­
      limits:
        memory: "512Mi"    # 512MB ì œí•œ (AWS CLIì— ì¶©ë¶„)
        cpu: "400m"        # 0.4 CPU ì œí•œ
    volumeMounts:
    - name: workspace-volume
      mountPath: /home/jenkins/agent
  volumes:
  - name: workspace-volume
    emptyDir: {}
            '''
        }
    }
    
    // í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
    environment {
        // AWS ê³µê°œ ì •ë³´ (ê¹ƒì— ì˜¬ë ¤ë„ ì•ˆì „)
        AWS_REGION = 'ap-northeast-2'        // ì„œìš¸ ë¦¬ì „
        ECR_REPOSITORY = 'pumati-dev-backend-ecr'  // ECR ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„
        
        // ì´ë¯¸ì§€ íƒœê·¸ ì„¤ì • (ë¸Œëœì¹˜ëª…ê³¼ ë¹Œë“œ ë²ˆí˜¸ ì¡°í•©)
        IMAGE_TAG = "${BRANCH_NAME}-${BUILD_NUMBER}"
        
        // Gradle í™ˆ ë””ë ‰í† ë¦¬ ì„¤ì • (ê¶Œí•œ ë¬¸ì œ í•´ê²°)
        GRADLE_USER_HOME = '/home/jenkins/agent/.gradle'
        GRADLE_OPTS = '-Dorg.gradle.daemon=false -Dorg.gradle.caching=false'
        
        // Java ë²„ì „ ì„¤ì • (ì‹œìŠ¤í…œ ê¸°ë³¸ Java ì‚¬ìš©)
        // Jenkins ì„œë²„ì— Java 21ì´ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•¨
        // JAVA_HOME = tool name: 'jdk-21', type: 'jdk'
        // PATH = "${JAVA_HOME}/bin:${PATH}"
    }
    
    stages {
        // 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        stage('Checkout') {
            steps {
                container('openjdk') {
                    echo 'ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ ì™„ë£Œ'
                    script {
                        // ë” ê°„ë‹¨í•˜ê³  ì•ˆì „í•œ Git ëª…ë ¹ì–´ ì‚¬ìš©
                        try {
                            def gitCommit = sh(
                                script: 'git rev-parse HEAD',
                                returnStdout: true
                            ).trim()
                            echo "Git Commit: ${gitCommit}"
                        } catch (Exception e) {
                            echo "Git commit ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${e.getMessage()}"
                        }
                        
                        try {
                            def gitBranch = sh(
                                script: 'git branch --show-current || echo "detached"',
                                returnStdout: true
                            ).trim()
                            echo "Git Branch: ${gitBranch}"
                        } catch (Exception e) {
                            echo "Git branch ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${e.getMessage()}"
                        }
                        
                        // ì‘ì—… ë””ë ‰í† ë¦¬ í™•ì¸
                        sh 'pwd'
                        sh 'ls -la'
                    }
                }
            }
        }
        
        // 2. í™˜ê²½ ì„¤ì • íŒŒì¼ ì¤€ë¹„
        stage('Setup Environment') {
            steps {
                container('openjdk') {
                    echo 'í™˜ê²½ ì„¤ì • íŒŒì¼ ë° AWS ì •ë³´ ì¤€ë¹„ ì¤‘...'
                    
                    script {
                        withCredentials([string(credentialsId: 'aws-account-id', variable: 'AWS_ACCOUNT_ID')]) {
                            env.DOCKER_IMAGE_NAME = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}:${IMAGE_TAG}"
                            env.LATEST_IMAGE_NAME = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}:latest"
                            echo "Docker ì´ë¯¸ì§€: ${env.DOCKER_IMAGE_NAME}"
                            echo "Latest ì´ë¯¸ì§€: ${env.LATEST_IMAGE_NAME}"
                        }
                    }
                    
                    withCredentials([file(credentialsId: 'be-env-local', variable: 'ENV_FILE')]) {
                        sh 'cp $ENV_FILE .env'
                        sh 'ls -la .env'
                    }
                }
            }
        }
        
        // 3. Gradle ë¹Œë“œ ì¤€ë¹„
        stage('Prepare Build') {
            steps {
                container('openjdk') {
                    echo 'Gradle ë¹Œë“œ ì¤€ë¹„ ì¤‘...'
                    script {
                        // Gradle í™ˆ ë””ë ‰í† ë¦¬ ìƒì„±
                        sh 'mkdir -p /home/jenkins/agent/.gradle'
                        sh 'id && pwd && ls -la /home/jenkins/agent/'
                        
                        try {
                            sh 'java -version'
                        } catch (Exception e) {
                            echo "Java ë²„ì „ í™•ì¸ ì‹¤íŒ¨: ${e.getMessage()}"
                        }
                        
                        try {
                            sh 'chmod +x gradlew'
                            echo 'âœ… gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ ì™„ë£Œ'
                        } catch (Exception e) {
                            echo "âŒ gradlew ê¶Œí•œ ì„¤ì • ì‹¤íŒ¨: ${e.getMessage()}"
                            echo "ğŸ›‘ Gradle ì„¤ì • ì‹¤íŒ¨ë¡œ ì¸í•´ íŒŒì´í”„ë¼ì¸ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
                            error("Gradle ê¶Œí•œ ì„¤ì • ì‹¤íŒ¨ë¡œ íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨")
                        }
                        
                        try {
                            sh 'GRADLE_USER_HOME=/home/jenkins/agent/.gradle ./gradlew --version'
                            echo 'âœ… Gradle ì„¤ì •ì´ ì •ìƒì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'
                        } catch (Exception e) {
                            echo "âŒ Gradle ë²„ì „ í™•ì¸ ì‹¤íŒ¨: ${e.getMessage()}"
                            echo "ğŸ›‘ Gradle ì„¤ì • ì‹¤íŒ¨ë¡œ ì¸í•´ íŒŒì´í”„ë¼ì¸ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
                            error("Gradle ì„¤ì • ì‹¤íŒ¨ë¡œ íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨")
                        }
                    }
                }
            }
        }
        
        // 4. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ì„ íƒì )
        stage('Test') {
            when {
                // PRì´ë‚˜ main ë¸Œëœì¹˜ì—ì„œë§Œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
                anyOf {
                    branch 'dev'
                    changeRequest()
                }
            }
            steps {
                container('openjdk') {
                    echo 'ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...'
                    script {
                        try {
                            // í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰
                            sh '''
                                # Gradle í™ˆ ë””ë ‰í† ë¦¬ í™•ì¸
                                export GRADLE_USER_HOME=/home/jenkins/agent/.gradle
                                mkdir -p $GRADLE_USER_HOME
                                
                                if [ -f .env ]; then
                                    echo "í™˜ê²½ íŒŒì¼ ë°œê²¬, ë¡œë“œ ì¤‘..."
                                    set -a && . ./.env && set +a
                                else
                                    echo "í™˜ê²½ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
                                fi
                                
                                echo "í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œì‘..."
                                echo "GRADLE_USER_HOME: $GRADLE_USER_HOME"
                                ./gradlew test --no-daemon --stacktrace --gradle-user-home=$GRADLE_USER_HOME
                            '''
                            echo "âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ í†µê³¼í–ˆìŠµë‹ˆë‹¤."
                        } catch (Exception e) {
                            echo "âŒ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.getMessage()}"
                            echo "ğŸ›‘ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ë¡œ ì¸í•´ íŒŒì´í”„ë¼ì¸ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
                            error("í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ë¡œ íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨")
                        }
                    }
                }
            }
            
            // í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë°œí–‰
            post {
                always {
                    container('openjdk') {
                        script {
                            try {
                                junit testResults: 'build/test-results/test/*.xml', allowEmptyResults: true
                                echo 'í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë°œí–‰ ì™„ë£Œ'
                            } catch (Exception e) {
                                echo "í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë°œí–‰ ì‹¤íŒ¨: ${e.getMessage()}"
                            }
                        }
                    }
                }
            }
        }
        
        // 5. ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
        stage('Build Application') {
            steps {
                container('openjdk') {
                    echo 'Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ì¤‘...'
                    script {
                        try {
                            sh '''
                                export GRADLE_USER_HOME=/home/jenkins/agent/.gradle
                                ./gradlew clean build -x test --no-daemon --stacktrace --gradle-user-home=$GRADLE_USER_HOME
                            '''
                            sh 'ls -la build/libs/'
                            echo 'âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'
                        } catch (Exception e) {
                            echo "âŒ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ì‹¤íŒ¨: ${e.getMessage()}"
                            echo "ğŸ›‘ ë¹Œë“œ ì‹¤íŒ¨ë¡œ ì¸í•´ íŒŒì´í”„ë¼ì¸ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
                            error("ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ì‹¤íŒ¨ë¡œ íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨")
                        }
                    }
                }
            }
        }
        
        // 6. ECR ë¡œê·¸ì¸ ë° ì„¤ì •
        stage('Setup ECR') {
            steps {
                container('aws-cli') {
                    echo 'ECR ë¡œê·¸ì¸ ë° ë¦¬í¬ì§€í† ë¦¬ ì„¤ì • ì¤‘...'
                    withCredentials([
                        string(credentialsId: 'aws-account-id', variable: 'AWS_ACCOUNT_ID'),
                        aws(credentialsId: 'aws-credentials', accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')
                    ]) {
                        sh 'aws --version'
                        sh 'aws sts get-caller-identity'
                        
                        // ECR ë¦¬í¬ì§€í† ë¦¬ ì¡´ì¬ í™•ì¸ ë° ìƒì„±
                        sh """
                            aws ecr describe-repositories --repository-names ${ECR_REPOSITORY} --region ${AWS_REGION} || \\
                            aws ecr create-repository --repository-name ${ECR_REPOSITORY} --region ${AWS_REGION}
                        """
                        
                        // Kanikoìš© ECR ì¸ì¦ ì„¤ì • íŒŒì¼ ìƒì„±
                        sh """
                            mkdir -p /home/jenkins/agent/.docker
                            aws ecr get-login-password --region ${AWS_REGION} | \\
                            echo "{\\"auths\\": {\\"${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com\\": {\\"auth\\": \\"\$(cat - | base64 -w0)\\"}}}" > /home/jenkins/agent/.docker/config.json
                        """
                    }
                }
            }
        }
        
        // 7. Kanikoë¡œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        stage('Build and Push Docker Image') {
            steps {
                container('kaniko') {
                    withCredentials([
                        string(credentialsId: 'aws-account-id', variable: 'AWS_ACCOUNT_ID'),
                        aws(credentialsId: 'aws-credentials', accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'),
                        file(credentialsId: 'be-env-local', variable: 'ENV_FILE')
                    ]) {
                        sh '''
                            # AWS í™˜ê²½ë³€ìˆ˜ ì„¤ì •
                            export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
                            export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
                            export AWS_DEFAULT_REGION=${AWS_REGION}
                            
                            # .env íŒŒì¼ ë³µì‚¬
                            cp $ENV_FILE .env
                            chmod 600 .env
                            
                            echo "í™˜ê²½ íŒŒì¼ ë¼ì¸ ìˆ˜: $(wc -l < .env)"
                            
                            # ECR ë¡œê·¸ì¸ (Kanikoìš©)
                            mkdir -p /kaniko/.docker
                            aws ecr get-login-password --region ${AWS_REGION} | \\
                            echo "{\\"auths\\": {\\"${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com\\": {\\"auth\\": \\"\$(cat - | base64 -w0)\\"}}}" > /kaniko/.docker/config.json
                            
                            # Kaniko ë¹Œë“œ ì‹¤í–‰
                            /kaniko/executor \\
                                --context=. \\
                                --dockerfile=ci/dev/Dockerfile \\
                                --destination=${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/pumati-dev-backend-ecr:jacky-${BUILD_NUMBER} \\
                                --destination=${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/pumati-dev-backend-ecr:latest \\
                                --cache=false \\
                                --verbosity=info \\
                                --cleanup
                        '''
                    }
                }
            }
        }
        
        // 8. GitOps - í—¬ë¦„ ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ë° í‘¸ì‹œ
        stage('Update GitOps Repository') {
            steps {
                container('openjdk') {
                    echo 'GitOps ë¦¬í¬ì§€í† ë¦¬ ì—…ë°ì´íŠ¸ ì¤‘...'
                    
                    withCredentials([
                        string(credentialsId: 'aws-account-id', variable: 'AWS_ACCOUNT_ID'),
                        string(credentialsId: 'github-pat', variable: 'GITHUB_TOKEN')
                    ]) {
                        script {
                            try {
                                sh '''
                                    # ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„±
                                    mkdir -p /tmp/gitops
                                    cd /tmp/gitops
                                    
                                    echo "ğŸ”„ GitOps ë¦¬í¬ì§€í† ë¦¬ í´ë¡  ì¤‘..."
                                    # GitHub í† í°ì„ ì‚¬ìš©í•˜ì—¬ í´ë¡  (í† í° ë§ˆìŠ¤í‚¹)
                                    git clone https://x-access-token:${GITHUB_TOKEN}@github.com/100-hours-a-week/8-pumati-cloud.git .
                                    
                                    # Git ì„¤ì • (ë¡œì»¬ ë¦¬í¬ì§€í† ë¦¬ì—ì„œë§Œ)
                                    git config user.name "Jenkins CI"
                                    git config user.email "jenkins@pumati.com"
                                    
                                    # jacky ë¸Œëœì¹˜ë¡œ ì²´í¬ì•„ì›ƒ (í—¬ë¦„ ì°¨íŠ¸ê°€ ìˆëŠ” ë¸Œëœì¹˜)
                                    echo "ğŸ”„ jacky ë¸Œëœì¹˜ë¡œ ì²´í¬ì•„ì›ƒ ì¤‘..."
                                    git checkout jacky
                                    
                                    # í˜„ì¬ ë¸Œëœì¹˜ í™•ì¸
                                    git branch -a
                                    git status
                                    
                                    # values.yaml íŒŒì¼ ê²½ë¡œ í™•ì¸
                                    echo "ğŸ“ í—¬ë¦„ ì°¨íŠ¸ êµ¬ì¡° í™•ì¸..."
                                    find . -name "values.yaml" -type f
                                    ls -la aws/dev/gitops/helm/backend/ || echo "ë°±ì—”ë“œ í—¬ë¦„ ë””ë ‰í† ë¦¬ í™•ì¸ ì¤‘..."
                                '''
                                
                                // ì´ë¯¸ì§€ íƒœê·¸ ì •ë³´ ì„¤ì •
                                def newImageTag = "${env.IMAGE_TAG}"
                                def fullImageName = "${env.DOCKER_IMAGE_NAME}"
                                
                                sh """
                                    cd /tmp/gitops
                                    
                                    # values.yaml íŒŒì¼ ê²½ë¡œ ì„¤ì • (backend ë””ë ‰í† ë¦¬ ë‚´)
                                    VALUES_FILE="aws/dev/gitops/helm/backend/values.yaml"
                                    
                                    if [ -f "\$VALUES_FILE" ]; then
                                        echo "ğŸ“ values.yaml íŒŒì¼ ë°œê²¬: \$VALUES_FILE"
                                        echo "í˜„ì¬ ë‚´ìš©:"
                                        cat "\$VALUES_FILE"
                                        
                                        echo ""
                                        echo "ğŸ”„ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸ ì¤‘..."
                                        echo "ìƒˆ ì´ë¯¸ì§€: ${fullImageName}"
                                        echo "ìƒˆ íƒœê·¸: ${newImageTag}"
                                        
                                        # ë°±ì—… ìƒì„±
                                        cp "\$VALUES_FILE" "\$VALUES_FILE.backup"
                                        
                                        # yqê°€ ì—†ìœ¼ë¯€ë¡œ sedë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
                                        # image.tag ë˜ëŠ” tag í•„ë“œ ì—…ë°ì´íŠ¸
                                        if grep -q "tag:" "\$VALUES_FILE"; then
                                            # tag: í˜•íƒœë¡œ ë˜ì–´ ìˆëŠ” ê²½ìš°
                                            sed -i "s|tag:.*|tag: \"${newImageTag}\"|g" "\$VALUES_FILE"
                                        elif grep -q "image:" "\$VALUES_FILE"; then
                                            # image: í˜•íƒœë¡œ ë˜ì–´ ìˆëŠ” ê²½ìš° (ì „ì²´ ì´ë¯¸ì§€ ê²½ë¡œ)
                                            sed -i "s|image:.*|image: \"${fullImageName}\"|g" "\$VALUES_FILE"
                                        else
                                            echo "âš ï¸ ì´ë¯¸ì§€ íƒœê·¸ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì— ì¶”ê°€í•©ë‹ˆë‹¤."
                                            echo "" >> "\$VALUES_FILE"
                                            echo "# Updated by Jenkins CI/CD" >> "\$VALUES_FILE"
                                            echo "image:" >> "\$VALUES_FILE"
                                            echo "  tag: \"${newImageTag}\"" >> "\$VALUES_FILE"
                                        fi
                                        
                                        echo ""
                                        echo "ğŸ“ ì—…ë°ì´íŠ¸ëœ ë‚´ìš©:"
                                        cat "\$VALUES_FILE"
                                        
                                        # Git ë³€ê²½ì‚¬í•­ í™•ì¸
                                        echo ""
                                        echo "ğŸ“Š Git ë³€ê²½ì‚¬í•­:"
                                        git diff "\$VALUES_FILE" || true
                                        
                                        # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
                                        if git diff --quiet "\$VALUES_FILE"; then
                                            echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
                                        else
                                            echo "âœ… ë³€ê²½ì‚¬í•­ ë°œê²¬, ì»¤ë°‹ ë° í‘¸ì‹œ ì§„í–‰..."
                                            
                                            # Git add, commit, push
                                            git add "\$VALUES_FILE"
                                            git commit -m "ğŸš€ Update backend image tag to ${newImageTag}
                                            
                                            - Image: ${fullImageName}
                                            - Build: ${BUILD_NUMBER}
                                            - Branch: ${BRANCH_NAME}
                                            - Commit: \$(git -C /home/jenkins/agent rev-parse --short HEAD 2>/dev/null || echo 'unknown')
                                            - Updated by Jenkins CI/CD"
                                            
                                            # ì›ê²© ë¦¬í¬ì§€í† ë¦¬ì— í‘¸ì‹œ (jacky ë¸Œëœì¹˜ë¡œ)
                                            git push origin jacky
                                            
                                            echo "ğŸ‰ GitOps ë¦¬í¬ì§€í† ë¦¬ ì—…ë°ì´íŠ¸ ì™„ë£Œ!"
                                        fi
                                    else
                                        echo "âŒ values.yaml íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: \$VALUES_FILE"
                                        echo "ğŸ“ ì‚¬ìš© ê°€ëŠ¥í•œ íŒŒì¼ë“¤:"
                                        find . -name "*.yaml" -o -name "*.yml" | head -20
                                        exit 1
                                    fi
                                """
                                
                            } catch (Exception e) {
                                echo "âŒ GitOps ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${e.getMessage()}"
                                echo "ğŸ” ë””ë²„ê·¸ ì •ë³´:"
                                sh '''
                                    cd /tmp/gitops 2>/dev/null || echo "gitops ë””ë ‰í† ë¦¬ ì—†ìŒ"
                                    pwd
                                    ls -la
                                    git status 2>/dev/null || echo "Git ìƒíƒœ í™•ì¸ ë¶ˆê°€"
                                '''
                                // GitOps ì‹¤íŒ¨ëŠ” ì „ì²´ ë¹Œë“œë¥¼ ì‹¤íŒ¨ì‹œí‚¤ì§€ ì•ŠìŒ
                                currentBuild.result = 'UNSTABLE'
                            }
                        }
                    }
                }
            }
        }
        
        // 9. ë¹Œë“œ ì •ë¦¬
        stage('Cleanup') {
            steps {
                container('openjdk') {
                    echo 'ë¹Œë“œ ì •ë¦¬ ì¤‘...'
                    sh '''
                        # ğŸ”¥ ì´ì œ ì—¬ê¸°ì„œ .env íŒŒì¼ ì •ë¦¬
                        rm -f .env || true
                        rm -rf /home/jenkins/agent/.docker || true
                        echo "ì •ë¦¬ ì™„ë£Œ"
                    '''
                }
            }
        }
    }
    
    // ë¹Œë“œ í›„ ì²˜ë¦¬
    post {
        always {
            script {
                echo 'ë¹Œë“œ íŒŒì´í”„ë¼ì¸ ì™„ë£Œ. ì‘ì—… ê³µê°„ì„ ì •ë¦¬í•©ë‹ˆë‹¤.'
                
                // Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì •ë¦¬
                try {
                    deleteDir()
                    echo 'ì‘ì—… ê³µê°„ ì •ë¦¬ ì™„ë£Œ'
                } catch (Exception e) {
                    echo "ì‘ì—… ê³µê°„ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œë¨): ${e.getMessage()}"
                }
            }
        }
        
        success {
            script {
                echo 'âœ… ë¹Œë“œ ë° GitOps ì—…ë°ì´íŠ¸ ì„±ê³µ! ğŸ‰'
                echo "ğŸ“¦ Docker ì´ë¯¸ì§€: ${env.DOCKER_IMAGE_NAME}"
                echo "ğŸ·ï¸  ì´ë¯¸ì§€ íƒœê·¸: ${env.IMAGE_TAG}"
                echo "ğŸ“ ECR ë¦¬í¬ì§€í† ë¦¬: ${ECR_REPOSITORY}"
                echo "ğŸŒ AWS ë¦¬ì „: ${AWS_REGION}"
                echo "ğŸ”„ GitOps: ArgoCDê°€ ìë™ìœ¼ë¡œ ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤"
                echo "ğŸ“‹ í—¬ë¦„ ì°¨íŠ¸: aws/dev/gitops/helm/backend/values.yaml ì—…ë°ì´íŠ¸ë¨"
            }
        }
        
        failure {
            script {
                echo 'âŒ ë¹Œë“œ ì‹¤íŒ¨!'
                echo "ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ì‹¤íŒ¨ ì›ì¸ì„ íŒŒì•…í•˜ì„¸ìš”."
                echo "ğŸŒ ë¹Œë“œ URL: ${env.BUILD_URL}"
            }
        }
        
        unstable {
            script {
                echo 'âš ï¸ ë¹Œë“œ ë¶ˆì•ˆì •'
                echo "ğŸ“Š í…ŒìŠ¤íŠ¸ì—ì„œ ì¼ë¶€ ì‹¤íŒ¨ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
            }
        }
    }
}
